<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulance Dispatch System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .main-content {
            display: flex;
            flex: 1;
            flex-direction: row;
            overflow: hidden;
        }

        .ambulance-list {
            width: 350px;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .header {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .ambulance-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .ambulance-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .ambulance-card.selected {
            border: 2px solid #e74c3c;
            background-color: #f9f9f9;
        }

        .ambulance-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .ambulance-type {
            font-weight: bold;
            font-size: 18px;
        }

        .ambulance-rate {
            color: #e74c3c;
            font-weight: bold;
        }

        .ambulance-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .ambulance-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .status-available {
            background-color: #d4edda;
            color: #155724;
        }

        .status-unavailable {
            background-color: #f8d7da;
            color: #721c24;
        }

        .distance-badge {
            background-color: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }

        .route-info {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .location-input-container {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        .location-input {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .location-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .distance-time {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-weight: bold;
            flex-wrap: wrap;
        }

        .large-icon {
            font-size: 48px;
        }

        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .booking-footer {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
        }

        .book-now-btn {
            background-color: white;
            color: #e74c3c;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .book-now-btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }

        .menu-toggle {
            display: none;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            border-radius: 4px;
        }

        .location-permission {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            text-align: center;
            display: none;
        }

        .location-permission button {
            background-color: white;
            color: #e74c3c;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
        }



        

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .ambulance-list {
                width: 100%;
                position: absolute;
                z-index: 1000;
                height: 60vh;
                bottom: 0;
                left: 0;
                transform: translateY(100%);
            }

            .ambulance-list.visible {
                transform: translateY(0);
            }

            .map-container {
                height: 60vh;
            }

            .menu-toggle {
                display: block;
            }

            .location-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" id="menuToggle">☰</button>
    
    <div class="container">
        <div class="location-permission" id="locationPermission">
            Allow location access to automatically set your pickup location and find nearby ambulances
            <button id="requestLocation">Allow</button>
        </div>
        
        <div class="main-content">
            <div class="ambulance-list" id="ambulanceList">
                <div class="header">
                    <h2>Available Ambulances</h2>
                </div>
                <div id="ambulancesContainer">
                    <!-- Ambulance cards will be inserted here by JavaScript -->
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="route-info">
                    <h3>Route Information</h3>
                    <div class="location-input-container">
                        <div class="location-input">
                            <input type="text" id="pickupLocation" placeholder="Enter pickup location" autocomplete="off" readonly>
                        </div>
                        <div class="location-input">
                            <input type="text" id="hospitalLocation" placeholder="Enter hospital location" autocomplete="off">
                            <div class="suggestions" id="hospitalSuggestions"></div>
                        </div>
                        <div class="action-buttons">
                            <button id="setRoute">Set Route</button>
                            <button id="findNearby">Find Nearby Ambulances</button>
                        </div>
                    </div>
                    <div class="route-details">
                        <div id="pickupPoint">Pickup: Not set</div>
                        <div id="hospitalPoint">Hospital: Not set</div>
                    </div>
                    <div class="distance-time">
                        <div id="distance">Distance: -</div>
                        <div id="time">Estimated Time: -</div>
                    </div>
                    <div id="routeStatus" class="status"></div>
                </div>
            </div>
        </div>

        <div class="booking-footer" id="bookingFooter">
            <button class="book-now-btn" id="bookNowBtn">Book Now - <span id="selectedAmbulanceType"></span> (₹<span id="selectedAmbulanceRate"></span>)</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        // Initialize map centered on India
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Ambulance data with realistic locations across major Indian cities
        const ambulanceData = [
             // Kolkata ambulances
            { id: 1, type: "Basic Life Support", baseRate: 1500, details: "Basic medical equipment, oxygen, first aid", available: true, location: [22.5726, 88.3639], contact: "9876543210", city: "Kolkata" },
            { id: 2, type: "Advanced Life Support", baseRate: 2500, details: "Advanced medical equipment, ECG monitor, defibrillator", available: true, location: [22.5359, 88.3067], contact: "9876543211", city: "Kolkata" },
            { id: 3, type: "Neonatal Ambulance", baseRate: 3000, details: "Specialized for newborns, incubator, pediatric equipment", available: true, location: [22.4964, 88.3695], contact: "9876543212", city: "Kolkata" },
            { id: 4, type: "Cardiac Ambulance", baseRate: 3500, details: "For heart patients, cardiac monitor, emergency meds", available: true, location: [22.5937, 88.2707], contact: "9876543213", city: "Kolkata" },
            { id: 5, type: "ICU Ambulance", baseRate: 4000, details: "Fully equipped ICU with ventilator and monitoring", available: true, location: [22.5176, 88.3834], contact: "9876543214", city: "Kolkata" },
            
            // West Bengal ambulances (other cities)
            { id: 6, type: "Basic Life Support", baseRate: 1800, details: "Basic medical equipment, oxygen, first aid", available: true, location: [23.3441, 85.3096], contact: "9876543215", city: "Durgapur" },
            { id: 7, type: "Advanced Life Support", baseRate: 2800, details: "Advanced medical equipment, ECG monitor, defibrillator", available: true, location: [22.4337, 87.3215], contact: "9876543216", city: "Kharagpur" },
            { id: 8, type: "Neonatal Ambulance", baseRate: 3200, details: "Specialized for newborns, incubator, pediatric equipment", available: true, location: [26.7271, 88.3953], contact: "9876543217", city: "Siliguri" },
            { id: 9, type: "Cardiac Ambulance", baseRate: 3800, details: "For heart patients, cardiac monitor, emergency meds", available: true, location: [23.6648, 86.1527], contact: "9876543218", city: "Asansol" },
            { id: 10, type: "ICU Ambulance", baseRate: 4200, details: "Fully equipped ICU with ventilator and monitoring", available: true, location: [22.8909, 88.4260], contact: "9876543219", city: "Howrah" }
        ];

        // DOM elements
        const ambulancesContainer = document.getElementById('ambulancesContainer');
        const pickupLocationInput = document.getElementById('pickupLocation');
        const hospitalLocationInput = document.getElementById('hospitalLocation');
        const setRouteBtn = document.getElementById('setRoute');
        const findNearbyBtn = document.getElementById('findNearby');
        const pickupPointDisplay = document.getElementById('pickupPoint');
        const hospitalPointDisplay = document.getElementById('hospitalPoint');
        const distanceDisplay = document.getElementById('distance');
        const timeDisplay = document.getElementById('time');
        const routeStatus = document.getElementById('routeStatus');
        const bookingFooter = document.getElementById('bookingFooter');
        const bookNowBtn = document.getElementById('bookNowBtn');
        const selectedAmbulanceType = document.getElementById('selectedAmbulanceType');
        const selectedAmbulanceRate = document.getElementById('selectedAmbulanceRate');
        const menuToggle = document.getElementById('menuToggle');
        const ambulanceList = document.getElementById('ambulanceList');
        const hospitalSuggestions = document.getElementById('hospitalSuggestions');
        const locationPermission = document.getElementById('locationPermission');
        const requestLocationBtn = document.getElementById('requestLocation');

        // Map variables
        let selectedAmbulance = null;
        let pickupLocation = null;
        let hospitalLocation = null;
        let routeControl = null;
        let ambulanceMarkers = [];
        let pickupMarker = null;
        let hospitalMarker = null;
        let currentLocationMarker = null;
        let ambulances = ambulanceData.map(a => ({ ...a, rate: a.baseRate }));
        let geocoder = null;
        let placesService = null;
        let debounceTimer = null;
        let userLocation = null;
        let locationAllowed = false;

        // Initialize the app
        function init() {
            // Show all ambulances initially
            renderAmbulanceList();
            addAmbulanceMarkers();
            setupEventListeners();
            
            // Show location permission banner if not already allowed
            if (localStorage.getItem('locationAllowed') !== 'true') {
                locationPermission.style.display = 'block';
            } else {
                locationAllowed = true;
                requestUserLocation();
            }
        }

        // Request user's location
        function requestUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        pickupLocation = userLocation;
                        updatePickupMarker();
                        
                        // Reverse geocode to get address
                        reverseGeocode(userLocation, (address) => {
                            pickupLocationInput.value = address;
                            pickupPointDisplay.textContent = `Pickup: ${address}`;
                        });
                        
                        // Center map on user's location
                        map.setView(userLocation, 13);
                        
                        // Find nearby ambulances
                        findNearbyAmbulances();
                        
                        // Hide permission banner
                        locationPermission.style.display = 'none';
                        
                        // Remember user's choice
                        localStorage.setItem('locationAllowed', 'true');
                        locationAllowed = true;
                    },
                    error => {
                        console.error("Error getting location:", error);
                        showStatus(routeStatus, "Could not get your location. Please enter manually.", 'error');
                        pickupLocationInput.readOnly = false;
                        locationPermission.style.display = 'none';
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showStatus(routeStatus, "Geolocation is not supported by your browser. Please enter manually.", 'error');
                pickupLocationInput.readOnly = false;
                locationPermission.style.display = 'none';
            }
        }

        // Reverse geocode coordinates to get address
        function reverseGeocode(coords, callback) {
            if (!window.google) {
                console.error("Google Maps API not loaded");
                return;
            }
            
            if (!geocoder) {
                geocoder = new google.maps.Geocoder();
            }
            
            const latLng = new google.maps.LatLng(coords[0], coords[1]);
            
            geocoder.geocode({ 'location': latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    callback(results[0].formatted_address);
                } else {
                    console.error("Geocoder failed:", status);
                    callback("Current Location");
                }
            });
        }

        // Initialize Google Maps services
        function initGoogleMaps() {
            if (!window.google) {
                console.error("Google Maps API not loaded");
                return;
            }
            
            geocoder = new google.maps.Geocoder();
            placesService = new google.maps.places.PlacesService(document.createElement('div'));
            
            // Setup hospital location input with hospital-only search
            setupHospitalSearch(hospitalLocationInput, hospitalSuggestions, (location, address) => {
                hospitalLocation = location;
                hospitalLocationInput.value = address;
                updateHospitalMarker();
                hospitalPointDisplay.textContent = `Hospital: ${address}`;
                if (selectedAmbulance && pickupLocation) {
                    updateRoute();
                }
            });
        }

        // Setup hospital search with suggestions
        function setupHospitalSearch(inputElement, suggestionsContainer, callback) {
            inputElement.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = inputElement.value.trim();
                    if (query.length > 1) { // Show suggestions after 1 character
                        searchHospitals(query, suggestionsContainer, (place) => {
                            inputElement.value = place.name || place.formatted_address;
                            suggestionsContainer.style.display = 'none';
                            callback(
                                [place.geometry.location.lat(), place.geometry.location.lng()],
                                place.name || place.formatted_address
                            );
                        });
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 300);
            });
            
            inputElement.addEventListener('focus', () => {
                if (inputElement.value.trim().length > 1 && suggestionsContainer.children.length > 0) {
                    suggestionsContainer.style.display = 'block';
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        // Search for hospitals using Google Places API
        function searchHospitals(query, container, callback) {
            const request = {
                query: query + ' hospital',
                fields: ['name', 'formatted_address', 'geometry'],
                types: ['hospital']
            };
            
            placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    container.innerHTML = '';
                    results.slice(0, 5).forEach(place => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = place.name || place.formatted_address;
                        item.addEventListener('click', () => {
                            callback(place);
                        });
                        container.appendChild(item);
                    });
                    container.style.display = 'block';
                }
            });
        }

        // Update pickup marker on map
        function updatePickupMarker() {
            if (pickupMarker) map.removeLayer(pickupMarker);
            
            pickupMarker = L.marker(pickupLocation, {
                icon: L.divIcon({
                    className: 'pickup-icon',
                    html: '<div class="large-icon">📍</div>',
                    iconSize: [48, 48],
                    iconAnchor: [24, 24]
                })
            }).addTo(map).bindPopup('Pickup Location');
            
            // Pan map to include both pickup and ambulance if selected
            const bounds = L.latLngBounds([pickupLocation]);
            if (selectedAmbulance) bounds.extend(selectedAmbulance.location);
            if (hospitalLocation) bounds.extend(hospitalLocation);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Update hospital marker on map
        function updateHospitalMarker() {
            if (hospitalMarker) map.removeLayer(hospitalMarker);
            
            hospitalMarker = L.marker(hospitalLocation, {
                icon: L.divIcon({
                    className: 'hospital-icon',
                    html: '<div class="large-icon">🏥</div>',
                    iconSize: [48, 48],
                    iconAnchor: [24, 24]
                })
            }).addTo(map).bindPopup('Hospital');
            
            // Pan map to include both hospital and pickup if selected
            const bounds = L.latLngBounds([hospitalLocation]);
            if (pickupLocation) bounds.extend(pickupLocation);
            if (selectedAmbulance) bounds.extend(selectedAmbulance.location);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Find nearby ambulances based on pickup location
        function findNearbyAmbulances() {
            if (!pickupLocation) {
                showStatus(routeStatus, 'Please set pickup location first', 'error');
                return;
            }
            
            // Calculate distances and sort ambulances by proximity
            ambulances.forEach(ambulance => {
                ambulance.distance = calculateDistance(
                    pickupLocation[0], pickupLocation[1],
                    ambulance.location[0], ambulance.location[1]
                );
                
                // Calculate dynamic fare based on distance (base rate + ₹10 per km)
                const distanceKm = ambulance.distance / 1000;
                ambulance.rate = Math.round(ambulance.baseRate + (distanceKm * 10));
            });
            
            // Sort by distance and filter available ambulances
            const nearbyAmbulances = [...ambulances]
                .filter(a => a.available)
                .sort((a, b) => a.distance - b.distance);
            
            // Update the ambulance list
            renderAmbulanceList(nearbyAmbulances);
            addAmbulanceMarkers(nearbyAmbulances);
            
            if (nearbyAmbulances.length > 0) {
                showStatus(routeStatus, `Found ${nearbyAmbulances.length} nearby ambulances`, 'success');
            } else {
                showStatus(routeStatus, 'No available ambulances nearby', 'error');
            }
        }

        // Render ambulance list with distance information
        function renderAmbulanceList(ambulancesToShow = ambulances) {
            ambulancesContainer.innerHTML = '';
            
            if (!locationAllowed && ambulancesToShow === ambulances) {
                // Show all ambulances without distance when location not allowed
                ambulancesToShow.forEach(ambulance => {
                    const card = createAmbulanceCard(ambulance, false);
                    ambulancesContainer.appendChild(card);
                });
            } else {
                // Show filtered ambulances with distance when location is allowed
                ambulancesToShow.forEach(ambulance => {
                    const card = createAmbulanceCard(ambulance, true);
                    ambulancesContainer.appendChild(card);
                });
            }
        }

        // Create an ambulance card element
        function createAmbulanceCard(ambulance, showDistance) {
            const card = document.createElement('div');
            card.className = `ambulance-card ${ambulance.available ? '' : 'unavailable'}`;
            if (!ambulance.available) {
                card.style.opacity = '0.6';
            }
            
            const distanceKm = showDistance && ambulance.distance ? 
                (ambulance.distance / 1000).toFixed(1) + ' km' : '';
            
            card.innerHTML = `
                <div class="ambulance-info">
                    <div>
                        <span class="ambulance-type">${ambulance.type}</span>
                        ${distanceKm ? `<span class="distance-badge">${distanceKm}</span>` : ''}
                    </div>
                    <div class="ambulance-rate">₹${ambulance.rate}</div>
                </div>
                <div class="ambulance-details">${ambulance.details}</div>
                <div class="ambulance-status ${ambulance.available ? 'status-available' : 'status-unavailable'}">
                    ${ambulance.available ? 'Available' : 'Not Available'} • ${ambulance.city}
                </div>
                ${ambulance.available ? `<div class="ambulance-contact">Contact: ${ambulance.contact}</div>` : ''}
            `;
            
            if (ambulance.available) {
                card.addEventListener('click', () => {
                    selectAmbulance(ambulance);
                });
            }
            
            return card;
        }

        // Add ambulance markers to map
        function addAmbulanceMarkers(ambulancesToShow = ambulances) {
            // Clear existing markers
            ambulanceMarkers.forEach(marker => map.removeLayer(marker));
            ambulanceMarkers = [];

            // Add new markers
            ambulancesToShow.forEach(ambulance => {
                if (ambulance.available) {
                    const marker = L.marker(ambulance.location, {
                        icon: L.divIcon({
                            className: 'ambulance-icon',
                            html: '<div class="large-icon">🚑</div>',
                            iconSize: [48, 48],
                            iconAnchor: [24, 24]
                        })
                    }).addTo(map).bindPopup(`
                        <strong>${ambulance.type}</strong><br>
                        Rate: ₹${ambulance.rate}<br>
                        ${ambulance.details}<br>
                        Contact: ${ambulance.contact}<br>
                        City: ${ambulance.city}
                    `);
                    ambulanceMarkers.push(marker);

                    marker.on('click', () => {
                        selectAmbulance(ambulance);
                    });
                }
            });
        }

        // Select an ambulance
        function selectAmbulance(ambulance) {
            // Update UI
            document.querySelectorAll('.ambulance-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const cardIndex = ambulances.findIndex(a => a.id === ambulance.id);
            if (cardIndex >= 0) {
                document.querySelectorAll('.ambulance-card')[cardIndex]?.classList.add('selected');
            }
            
            selectedAmbulance = ambulance;
            showStatus(routeStatus, `${ambulance.type} selected (${ambulance.city})`, 'success');
            
            // Update booking footer
            selectedAmbulanceType.textContent = ambulance.type;
            selectedAmbulanceRate.textContent = ambulance.rate;
            bookingFooter.style.display = 'block';
            
            // Center map on selected ambulance
            const bounds = L.latLngBounds([ambulance.location]);
            if (pickupLocation) bounds.extend(pickupLocation);
            if (hospitalLocation) bounds.extend(hospitalLocation);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // If we have route points, update the route
            if (pickupLocation && hospitalLocation) {
                updateRoute();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            setRouteBtn.addEventListener('click', () => {
                if (!pickupLocation) {
                    showStatus(routeStatus, 'Please set pickup location first', 'error');
                    return;
                }
                
                if (!hospitalLocation) {
                    showStatus(routeStatus, 'Please set hospital location', 'error');
                    return;
                }
                
                if (selectedAmbulance) {
                    updateRoute();
                } else {
                    showStatus(routeStatus, 'Please select an ambulance first', 'error');
                }
            });
            
            findNearbyBtn.addEventListener('click', findNearbyAmbulances);
            
            bookNowBtn.addEventListener('click', () => {
    if (selectedAmbulance && pickupLocation && hospitalLocation) {
        // Create popup for mobile number
        const mobilePopup = document.createElement('div');
        mobilePopup.className = 'mobile-popup';
        mobilePopup.innerHTML = `
            <div class="popup-content">
                <h3>Enter Your Mobile Number</h3>
                <p>We'll send booking confirmation details to this number</p>
                <input type="tel" id="mobileNumber" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required>
                <button id="submitMobile">Submit</button>
            </div>
        `;
        document.body.appendChild(mobilePopup);
        
         // Add styles dynamically (better to put these in your CSS file)
        const style = document.createElement('style');
        style.textContent = `
            .mobile-popup {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(2px);
            }
            .popup-content {
                background-color: #ffffff;
                padding: 25px;
                border-radius: 12px;
                width: 90%;
                max-width: 350px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                text-align: center;
                animation: popIn 0.3s ease-out;
            }
            .popup-content h3 {
                margin: 0 0 15px 0;
                color: #2c3e50;
                font-size: 1.4rem;
            }
            .popup-content p {
                color: #7f8c8d;
                margin-bottom: 20px;
                font-size: 0.95rem;
            }
            .popup-content input {
                width: 100%;
                padding: 12px 15px;
                margin-bottom: 20px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                box-sizing: border-box;
                transition: border 0.3s;
            }
            .popup-content input:focus {
                border-color: #3498db;
                outline: none;
            }
            .popup-content button {
                background-color: #3498db;
                color: white;
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                width: 100%;
                transition: background-color 0.3s;
            }
            .popup-content button:hover {
                background-color: #2980b9;
            }
            @keyframes popIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        `;
        document.head.appendChild(style);
        // Handle mobile number submission
        document.getElementById('submitMobile').addEventListener('click', () => {
            const mobileNumber = document.getElementById('mobileNumber').value;
            if (/^[0-9]{10}$/.test(mobileNumber)) {
                // In a real app, this would send a booking request to your backend
                showStatus(routeStatus, `Booking confirmed! ${selectedAmbulance.type} ambulance (₹${selectedAmbulance.rate}) is on its way from ${selectedAmbulance.city}. Contact: ${selectedAmbulance.contact}`, 'success');
                
                // Simulate ambulance becoming unavailable
                selectedAmbulance.available = false;
                renderAmbulanceList();
                addAmbulanceMarkers();
                selectedAmbulance = null;
                bookingFooter.style.display = 'none';
                
                // Remove popup
                document.body.removeChild(mobilePopup);
                
                // Redirect to thank you page after a delay
                setTimeout(() => {
                    window.location.href = 'thankyou.html';
                }, 2000);
            } else {
                alert('Please enter a valid 10-digit mobile number');
            }
        });
    } else {
        showStatus(routeStatus, 'Please select an ambulance and set the route first', 'error');
    }
});

        menuToggle.addEventListener('click', () => {
        ambulanceList.classList.toggle('visible');
        });

        // Close ambulance list when clicking on map on mobile
        map.on('click', () => {
        if (window.innerWidth <= 768) {
        ambulanceList.classList.remove('visible');
        }
        });

        // Request location permission
        requestLocationBtn.addEventListener('click', requestUserLocation);

            
        }

        // Update the route on the map
        function updateRoute() {
            if (!selectedAmbulance || !pickupLocation || !hospitalLocation) return;
            
            // Remove existing route if any
            if (routeControl) {
                map.removeControl(routeControl);
            }
            
            // Create new route (ambulance -> pickup -> hospital)
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(selectedAmbulance.location[0], selectedAmbulance.location[1]),
                    L.latLng(pickupLocation[0], pickupLocation[1]),
                    L.latLng(hospitalLocation[0], hospitalLocation[1])
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                lineOptions: {
                    styles: [{ 
                        color: '#e74c3c', 
                        weight: 6,
                        opacity: 0.8
                    }]
                },
                createMarker: function() { return null; } // Disable default markers
            }).addTo(map);
            
            // Listen to route calculation
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0];
                
                // Display distance and time
                const distanceKm = (route.summary.totalDistance / 1000).toFixed(1);
                const estimatedTime = Math.round(route.summary.totalTime / 60); // Convert to minutes
                
                distanceDisplay.textContent = `Distance: ${distanceKm} km`;
                timeDisplay.textContent = `Estimated Time: ${estimatedTime} mins`;
            });
        }

        // Calculate distance between two points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Show status message
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                if (element.textContent === message) {
                    element.style.display = 'none';
                }
            }, 5000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
        
        // Initialize Google Maps when loaded
        function initGoogleMapsAPI() {
            initGoogleMaps();
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlCKNeyGr9Op0gZkys8SFeY6KMFp7p4GM&libraries=places&callback=initGoogleMapsAPI" async defer></script>
</body>
</html>